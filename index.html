<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries for PDF & QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #198754;
            --bg-color: #f8f9fa;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            direction: rtl;
            text-align: right;
            padding-bottom: 50px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ±ÙˆØª */
        .custom-card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            background: #fff;
            overflow: hidden;
            transition: transform 0.3s;
            margin-bottom: 20px;
        }

        .card-header-custom {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© */
        .image-display-area {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            border-bottom: 1px solid #ddd;
            overflow: hidden;
        }

        .image-display-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„ */
        .form-control {
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #ced4da;
        }

        .btn-custom {
            border-radius: 10px;
            padding: 12px;
            font-weight: bold;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }

        /* Ø§Ù„Ù†ØµÙˆØµ */
        .product-title {
            font-size: 26px;
            font-weight: 700;
            color: #333;
            margin-top: 15px;
        }

        .product-price {
            font-size: 22px;
            font-weight: bold;
            color: var(--secondary-color);
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .d-none-custom {
            display: none !important;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #invoiceArea {
            background: white;
            padding: 20px;
            width: 600px; 
            position: absolute;
            top: -9999px;
            left: -9999px;
            z-index: -1;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            
            <!-- ============================ -->
            <!-- SECTION 1: SELLER PANEL (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹) -->
            <!-- ============================ -->
            <div id="sellerSection" class="custom-card d-none-custom">
                <div class="card-header-custom">
                    <i class="fas fa-store me-2"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ - Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
                </div>
                
                <div class="card-body p-4">
                    <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
                    <div class="mb-3 text-center">
                        <div id="sellerImagePreview" class="image-display-area rounded mb-3">
                            <span>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</span>
                        </div>
                        <div class="d-flex gap-2">
                            <label class="btn btn-outline-primary w-50">
                                <i class="fas fa-upload"></i> Ø±ÙØ¹ ØµÙˆØ±Ø©
                                <input type="file" id="uploadInput" accept="image/*" hidden>
                            </label>
                            <label class="btn btn-outline-secondary w-50">
                                <i class="fas fa-camera"></i> ÙƒØ§Ù…ÙŠØ±Ø§
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>
                            </label>
                        </div>
                    </div>

                    <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
                    <form id="sellerForm">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <input type="text" class="form-control" id="productNameInput" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø¹Ø© Ø°ÙƒÙŠØ©" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <input type="number" class="form-control" id="productPriceInput" placeholder="Ù…Ø«Ø§Ù„: 50000" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <textarea class="form-control" id="productDescInput" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬..."></textarea>
                        </div>

                        <hr>
                        
                        <button type="button" id="generateLinkBtn" class="btn btn-primary btn-custom">
                            <i class="fas fa-link"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø·Ù„Ø¨
                        </button>
                    </form>

                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· -->
                    <div id="resultArea" class="mt-4 d-none">
                        <div class="alert alert-success">
                            <strong>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!</strong>
                            <p class="small text-muted mt-2">Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†:</p>
                            <textarea id="generatedLink" class="form-control mb-2" rows="3" readonly></textarea>
                            <button onclick="copyLink()" class="btn btn-sm btn-outline-success w-100">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                            <a id="previewLink" href="#" target="_blank" class="btn btn-sm btn-outline-primary w-100 mt-2">Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙØ­Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================ -->
            <!-- SECTION 2: CUSTOMER PANEL (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†) -->
            <!-- ============================ -->
            <div id="customerSection" class="d-none-custom">
                <!-- Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ -->
                <div class="custom-card mb-4">
                    <div id="customerImageDisplay" class="image-display-area">
                        <!-- Ø§Ù„ØµÙˆØ±Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                    </div>
                    <div class="card-body text-center">
                        <h2 id="dispName" class="product-title">...</h2>
                        <p id="dispPrice" class="product-price">...</p>
                        <p id="dispDesc" class="text-muted">...</p>
                    </div>
                </div>

                <!-- Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø²Ø¨ÙˆÙ† -->
                <div class="custom-card">
                    <div class="card-header-custom" style="background-color: var(--secondary-color);">
                        <i class="fas fa-shopping-cart me-2"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
                    </div>
                    <div class="card-body p-4">
                        <form id="orderForm">
                            <div class="mb-3">
                                <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
                                <input type="text" class="form-control" id="custName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input type="tel" class="form-control" id="custPhone" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ÙƒØªØ§Ø¨Ø©)</label>
                                <input type="text" class="form-control" id="custAddress" required>
                            </div>

                            <!-- Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ -->
                            <div class="mb-3">
                                <label class="form-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</label>
                                <div class="input-group">
                                    <button type="button" id="getLocationBtn" class="btn btn-outline-danger">
                                        <i class="fas fa-map-marker-alt"></i> ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ
                                    </button>
                                    <input type="text" id="locationStatus" class="form-control" placeholder="Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯" readonly>
                                </div>
                                <div id="mapFrame" class="mt-2" style="display:none;">
                                    <iframe width="100%" height="200" style="border:0; border-radius:10px;" loading="lazy" allowfullscreen id="googleMap"></iframe>
                                </div>
                                <input type="hidden" id="lat">
                                <input type="hidden" id="long">
                            </div>

                            <button type="submit" class="btn btn-success btn-custom">
                                <i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                            </button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ============================ -->
<!-- SECTION 3: INVOICE LAYOUT (Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
<!-- ============================ -->
<div id="invoiceArea">
    <div style="border: 2px solid #333; padding: 20px; text-align: center; background: #fff;">
        <h2 style="margin-bottom: 20px; font-family: 'Cairo', sans-serif;">ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨ Ù…Ù†ØªØ¬</h2>
        
        <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
        <div style="display: flex; justify-content: center; margin-bottom: 15px;">
            <img id="invImg" src="" style="width: 150px; height: 150px; object-fit: cover; border-radius: 10px; border: 1px solid #ddd;">
        </div>
        
        <table class="table table-bordered mt-3" style="width: 100%; direction: rtl; text-align: right; font-family: 'Cairo', sans-serif;">
            <tbody>
                <tr><th width="30%" style="background:#f0f0f0;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><td id="invOrderId"></td></tr>
                <tr><th style="background:#f0f0f0;">Ø§Ù„Ù…Ù†ØªØ¬</th><td id="invProdName"></td></tr>
                <tr><th style="background:#f0f0f0;">Ø§Ù„Ø³Ø¹Ø±</th><td id="invPrice"></td></tr>
                <tr><th style="background:#f0f0f0;">Ø§Ù„Ø²Ø¨ÙˆÙ†</th><td id="invCustName"></td></tr>
                <tr><th style="background:#f0f0f0;">Ø§Ù„Ù‡Ø§ØªÙ</th><td id="invPhone"></td></tr>
                <tr><th style="background:#f0f0f0;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><td id="invAddress"></td></tr>
                <tr><th style="background:#f0f0f0;">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</th><td id="invLocation"></td></tr>
                <tr><th style="background:#f0f0f0;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><td id="invDate"></td></tr>
            </tbody>
        </table>
        
        <div class="mt-4" style="display: flex; justify-content: center;">
            <div id="qrcode"></div>
        </div>
        <p class="mt-2 text-muted" style="font-family: 'Cairo', sans-serif;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§</p>
    </div>
</div>

<!-- Javascript Logic -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ================= GLOBAL VARIABLES =================
    let productBase64 = null;
    let productId = null;

    // ================= MAIN ROUTER (ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµÙØ­Ø§Øª) =================
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.has('id')) {
            // ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· -> Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†
            document.getElementById('sellerSection').classList.add('d-none-custom');
            document.getElementById('customerSection').classList.remove('d-none-custom');
            initCustomerPage(urlParams);
        } else {
            // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù -> Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹
            document.getElementById('sellerSection').classList.remove('d-none-custom');
            document.getElementById('customerSection').classList.add('d-none-custom');
            initSellerPage();
        }
    });

    // ================= HELPER FUNCTIONS =================
    function convertToBase64(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function () { callback(reader.result); };
        reader.onerror = function (error) { console.log('Error: ', error); };
    }

    function generateUUID() {
        return 'xxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // ================= SELLER LOGIC (ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø§Ø¦Ø¹) =================
    function initSellerPage() {
        const uploadInput = document.getElementById('uploadInput');
        const cameraInput = document.getElementById('cameraInput');
        const imagePreview = document.getElementById('sellerImagePreview');

        const handleImage = (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 500000) { 
                    alert("ØªÙ†Ø¨ÙŠÙ‡: Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­. ÙŠÙØ¶Ù„ ØµÙˆØ± Ø£Ù‚Ù„ Ù…Ù† 500KB.");
                }
                convertToBase64(file, (base64) => {
                    productBase64 = base64;
                    imagePreview.innerHTML = `<img src="${base64}" alt="Preview">`;
                });
            }
        };

        if(uploadInput) uploadInput.addEventListener('change', handleImage);
        if(cameraInput) cameraInput.addEventListener('change', handleImage);

        document.getElementById('generateLinkBtn').addEventListener('click', () => {
            const name = document.getElementById('productNameInput').value;
            const price = document.getElementById('productPriceInput').value;
            const desc = document.getElementById('productDescInput').value;

            if (!name || !price) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø³Ø¹Ø±');
                return;
            }

            const params = new URLSearchParams();
            params.set('id', generateUUID());
            params.set('name', name);
            params.set('price', price);
            params.set('desc', desc);
            if (productBase64) params.set('img', productBase64);

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const currentUrl = window.location.href.split('?')[0];
            const fullLink = `${currentUrl}?${params.toString()}`;

            const resultArea = document.getElementById('resultArea');
            resultArea.classList.remove('d-none');
            document.getElementById('generatedLink').value = fullLink;
            document.getElementById('previewLink').href = fullLink;
            
            // ØªÙ…Ø±ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø£Ø³ÙÙ„
            resultArea.scrollIntoView({behavior: "smooth"});
        });
    }

    function copyLink() {
        const copyText = document.getElementById("generatedLink");
        copyText.select();
        document.execCommand("copy");
        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!");
    }

    // ================= CUSTOMER LOGIC (ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø²Ø¨ÙˆÙ†) =================
    function initCustomerPage(params) {
        // 1. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const pName = params.get('name') || "Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        const pPrice = params.get('price') || "0";
        const pDesc = params.get('desc') || "";
        const pImg = params.get('img');
        productId = params.get('id');

        document.getElementById('dispName').textContent = pName;
        document.getElementById('dispPrice').textContent = pPrice + " Ø¯.Ø¹";
        document.getElementById('dispDesc').textContent = pDesc;

        if (pImg) {
            document.getElementById('customerImageDisplay').innerHTML = `<img src="${pImg}" alt="Product">`;
            document.getElementById('invImg').src = pImg; 
        } else {
            document.getElementById('customerImageDisplay').innerHTML = `<div class="p-5">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>`;
            document.getElementById('invImg').style.display = 'none';
        }

        // 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        const locBtn = document.getElementById('getLocationBtn');
        locBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                locBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ¯...';
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const long = pos.coords.longitude;
                    
                    document.getElementById('lat').value = lat;
                    document.getElementById('long').value = long;
                    document.getElementById('locationStatus').value = `${lat}, ${long}`;
                    
                    const mapFrame = document.getElementById('googleMap');
                    mapFrame.src = `https://maps.google.com/maps?q=${lat},${long}&z=15&output=embed`;
                    document.getElementById('mapFrame').style.display = 'block';
                    
                    locBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯';
                    locBtn.classList.replace('btn-outline-danger', 'btn-success');
                }, (err) => {
                    alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: " + err.message);
                    locBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
                });
            } else {
                alert("Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
            }
        });

        // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (PDF + WhatsApp)
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
            btn.disabled = true;

            const cName = document.getElementById('custName').value;
            const cPhone = document.getElementById('custPhone').value;
            const cAddress = document.getElementById('custAddress').value;
            const lat = document.getElementById('lat').value;
            const long = document.getElementById('long').value;
            const dateNow = new Date().toLocaleString('ar-IQ');

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            document.getElementById('invOrderId').innerText = productId;
            document.getElementById('invProdName').innerText = pName;
            document.getElementById('invPrice').innerText = pPrice + " Ø¯.Ø¹";
            document.getElementById('invCustName').innerText = cName;
            document.getElementById('invPhone').innerText = cPhone;
            document.getElementById('invAddress').innerText = cAddress;
            document.getElementById('invLocation').innerText = lat ? `${lat}, ${long}` : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            document.getElementById('invDate').innerText = dateNow;

            // ØªÙˆÙ„ÙŠØ¯ QR
            document.getElementById('qrcode').innerHTML = ""; 
            new QRCode(document.getElementById("qrcode"), {
                text: `Order:${productId}|Cust:${cName}|Ph:${cPhone}`,
                width: 100,
                height: 100
            });

            // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„ØªÙˆÙ„ÙŠØ¯ QR Ø«Ù… Ø¥Ù†Ø´Ø§Ø¡ PDF
            setTimeout(() => {
                const invoiceElement = document.getElementById('invoiceArea');
                
                // ØªØ­ÙˆÙŠÙ„ HTML Ø¥Ù„Ù‰ ØµÙˆØ±Ø© (Canvas) Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
                html2canvas(invoiceElement, { scale: 2, useCORS: true }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`order_${productId}.pdf`);

                    // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ PDFØŒ Ù†Ø±Ø³Ù„ ÙˆØ§ØªØ³Ø§Ø¨
                    sendWhatsApp(cName, cPhone, cAddress, lat, long, pName, pPrice, pDesc);
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }, 500);
        });
    }

    function sendWhatsApp(cName, cPhone, cAddress, lat, long, pName, pPrice, pDesc) {
        let mapLink = (lat && long) ? `https://www.google.com/maps?q=${lat},${long}` : "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯";
        
        const waMessage = `
ğŸ”¥ *Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯* ğŸ”¥
------------------
ğŸ‘¤ *Ø§Ù„Ø²Ø¨ÙˆÙ†:* ${cName}
ğŸ“± *Ø§Ù„Ù‡Ø§ØªÙ:* ${cPhone}
ğŸ  *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${cAddress}
ğŸ“ *Ø§Ù„Ù…ÙˆÙ‚Ø¹:* ${mapLink}
------------------
ğŸ“¦ *Ø§Ù„Ù…Ù†ØªØ¬:* ${pName}
ğŸ’° *Ø§Ù„Ø³Ø¹Ø±:* ${pPrice}
ğŸ“ *Ø§Ù„ØªÙØ§ØµÙŠÙ„:* ${pDesc}
ğŸ†” *Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:* ${productId}
        `.trim();

        const encodedMsg = encodeURIComponent(waMessage);
        const waNumber = "9647503727069"; 
        
        // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨
        setTimeout(() => {
            window.open(`https://wa.me/${waNumber}?text=${encodedMsg}`, '_blank');
        }, 1000);
    }
</script>

</body>
</html>